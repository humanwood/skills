<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guardian Security Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --bg2: #161b22; --bg3: #1c2128; --border: #30363d;
    --text: #e6edf3; --muted: #7d8590; --green: #3fb950; --red: #f85149;
    --orange: #db6d28; --yellow: #d29922; --blue: #58a6ff; --purple: #bc8cff;
    --shield: #3fb950;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace; font-size: 14px; min-height: 100vh; }

  header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; gap: 12px; }
  header .shield { font-size: 28px; }
  header h1 { font-size: 20px; font-weight: 700; color: var(--shield); }
  header .subtitle { color: var(--muted); font-size: 12px; margin-top: 2px; }
  header .status-badge { margin-left: auto; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1px solid; }
  .status-active { background: rgba(63,185,80,.15); color: var(--green); border-color: var(--green); }
  .status-monitor { background: rgba(210,153,34,.15); color: var(--yellow); border-color: var(--yellow); }
  .status-disabled { background: rgba(248,81,73,.15); color: var(--red); border-color: var(--red); }

  .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

  /* Stat cards */
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .stat-card .label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
  .stat-card .value { font-size: 28px; font-weight: 700; }
  .stat-card .sub { font-size: 11px; color: var(--muted); margin-top: 4px; }
  .val-green { color: var(--green); }
  .val-red { color: var(--red); }
  .val-orange { color: var(--orange); }
  .val-yellow { color: var(--yellow); }
  .val-blue { color: var(--blue); }

  /* Panels */
  .panels { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 24px; }
  @media (max-width: 900px) { .panels { grid-template-columns: 1fr; } }
  .panel { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .panel-header { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
  .panel-header .refresh-ts { color: var(--muted); font-size: 11px; font-weight: 400; }
  .panel-body { padding: 16px; }

  /* Threats table */
  .threats-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .threats-table th { text-align: left; padding: 8px 10px; border-bottom: 1px solid var(--border); color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
  .threats-table td { padding: 8px 10px; border-bottom: 1px solid rgba(48,54,61,.5); vertical-align: top; }
  .threats-table tr:last-child td { border-bottom: none; }
  .threats-table tr:hover td { background: rgba(255,255,255,.03); }

  .sev-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .sev-critical { background: rgba(248,81,73,.2); color: var(--red); border: 1px solid rgba(248,81,73,.4); }
  .sev-high { background: rgba(219,109,40,.2); color: var(--orange); border: 1px solid rgba(219,109,40,.4); }
  .sev-medium { background: rgba(210,153,34,.2); color: var(--yellow); border: 1px solid rgba(210,153,34,.4); }
  .sev-low { background: rgba(88,166,255,.2); color: var(--blue); border: 1px solid rgba(88,166,255,.4); }

  .channel-tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 11px; background: rgba(255,255,255,.06); color: var(--muted); }
  .threat-desc { max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .threat-ts { color: var(--muted); font-size: 11px; white-space: nowrap; }
  .threat-meta { color: var(--muted); font-size: 11px; margin-top: 4px; }
  .context-block { margin-top: 6px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: 'SFMono-Regular','Consolas',monospace; font-size: 11px; white-space: pre-wrap; line-height: 1.5; max-width: 100%; overflow-x: auto; }
  .context-block .ctx-line { display: block; padding: 2px 0; }
  .context-block .ctx-match { background: rgba(248,81,73,.15); border-left: 3px solid var(--red); padding-left: 8px; font-weight: 600; }
  .actions { display: flex; gap: 6px; flex-wrap: wrap; }
  .btn { cursor: pointer; padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: rgba(255,255,255,.04); color: var(--text); font-size: 12px; transition: background .1s ease, border-color .1s ease; }
  .btn:hover { background: rgba(88,166,255,.1); border-color: var(--blue); }
  .btn-ghost { background: transparent; }
  .btn-outline { border-color: var(--blue); color: var(--blue); background: rgba(88,166,255,.08); }
  .btn-danger { border-color: var(--red); color: var(--red); background: rgba(248,81,73,.08); }
  .btn-danger:hover { background: rgba(248,81,73,.15); }
  .btn-warning { border-color: var(--orange); color: var(--orange); background: rgba(219,109,40,.08); }
  .btn-warning:hover { background: rgba(219,109,40,.15); }
  .btn-success { border-color: var(--green); color: var(--green); background: rgba(63,185,80,.08); }
  .btn-success:hover { background: rgba(63,185,80,.15); }
  .ts-main { color: var(--text); font-size: 13px; }
  .ts-sub { color: var(--muted); font-size: 11px; }
  .empty-row { text-align: center; color: var(--muted); padding: 32px !important; }

  /* Config panel */
  .config-list { list-style: none; }
  .config-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(48,54,61,.5); font-size: 13px; }
  .config-list li:last-child { border-bottom: none; }
  .config-key { color: var(--muted); }
  .config-val { font-weight: 500; }
  .config-val.on { color: var(--green); }
  .config-val.off { color: var(--red); }
  .config-val.warn { color: var(--yellow); }

  /* Channel breakdown */
  .channel-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid rgba(48,54,61,.5); font-size: 13px; }
  .channel-row:last-child { border-bottom: none; }
  .channel-name { flex: 1; text-transform: capitalize; }
  .channel-bar-wrap { flex: 2; background: rgba(255,255,255,.06); border-radius: 4px; height: 8px; overflow: hidden; }
  .channel-bar { height: 100%; border-radius: 4px; background: var(--shield); }
  .channel-count { min-width: 40px; text-align: right; color: var(--muted); font-size: 12px; }

  /* Admin commands */
  .cmd-block { background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: 'SFMono-Regular', 'Consolas', monospace; font-size: 12px; line-height: 1.8; color: var(--text); overflow-x: auto; }
  .cmd-comment { color: var(--muted); }
  .cmd-bin { color: var(--blue); }
  .cmd-arg { color: var(--green); }

  /* Alert */
  .alert-bar { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
  .alert-critical { background: rgba(248,81,73,.12); border: 1px solid rgba(248,81,73,.3); color: var(--red); }
  .alert-high { background: rgba(219,109,40,.12); border: 1px solid rgba(219,109,40,.3); color: var(--orange); }
  .alert-info { background: rgba(63,185,80,.1); border: 1px solid rgba(63,185,80,.25); color: var(--green); }

  /* Footer */
  footer { border-top: 1px solid var(--border); padding: 16px 24px; color: var(--muted); font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
  .footer-links a { color: var(--blue); text-decoration: none; margin-left: 16px; }

  /* Loading */
  .loading { color: var(--muted); text-align: center; padding: 32px; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--shield); border-radius: 50%; animation: spin .7s linear infinite; margin-right: 8px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>
  <span class="shield">ğŸ›¡ï¸</span>
  <div>
    <h1>Guardian Security</h1>
    <div class="subtitle">OpenClaw agent immune system Â· real-time threat monitoring</div>
  </div>
  <span id="header-badge" class="status-badge status-active">â— ACTIVE</span>
</header>

<div class="container">

  <!-- Alert bar (shown only on high/critical threats) -->
  <div id="alert-bar" style="display:none"></div>

  <!-- Stats row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="label">Messages Scanned</div>
      <div class="value val-blue" id="stat-scanned">â€”</div>
      <div class="sub" id="stat-scan-rate">loading...</div>
    </div>
    <div class="stat-card">
      <div class="label">Active Threats</div>
      <div class="value val-red" id="stat-threats">â€”</div>
      <div class="sub" id="stat-threat-sub">loading...</div>
    </div>
    <div class="stat-card">
      <div class="label">Clean Rate</div>
      <div class="value val-green" id="stat-clean">â€”</div>
      <div class="sub">messages with no threat</div>
    </div>
    <div class="stat-card">
      <div class="label">Signatures</div>
      <div class="value val-purple" id="stat-sigs">â€”</div>
      <div class="sub">active threat definitions</div>
    </div>
    <div class="stat-card">
      <div class="label">Last Scan</div>
      <div class="value" id="stat-last" style="font-size:18px">â€”</div>
      <div class="sub" id="stat-last-sub"></div>
    </div>
  </div>

  <!-- Main panels -->
  <div class="panels">

    <!-- Recent threats -->
    <div class="panel">
      <div class="panel-header">
        ğŸš¨ Recent Threats
        <span class="refresh-ts" id="threats-ts">refreshing...</span>
      </div>
      <div class="panel-body" style="padding:0">
        <table class="threats-table">
          <thead>
            <tr>
              <th>Severity</th>
              <th>Channel</th>
              <th>Details &amp; Context</th>
              <th>Detected</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="threats-tbody">
            <tr><td class="empty-row" colspan="5"><span class="spinner"></span>Loading threats...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Right column -->
    <div style="display:flex;flex-direction:column;gap:16px">

      <!-- Channel breakdown -->
      <div class="panel">
        <div class="panel-header">ğŸ“¡ Channels Monitored</div>
        <div class="panel-body" id="channels-panel">
          <div class="loading"><span class="spinner"></span>loading</div>
        </div>
      </div>

      <!-- Config -->
      <div class="panel">
        <div class="panel-header">âš™ï¸ Configuration</div>
        <div class="panel-body">
          <ul class="config-list" id="config-list">
            <li><span class="config-key">Loading...</span></li>
          </ul>
        </div>
      </div>

    </div>
  </div>

  <!-- Admin commands panel -->
  <div class="panel" style="margin-bottom:24px">
    <div class="panel-header">ğŸ”§ Admin Commands</div>
    <div class="panel-body">
      <div class="cmd-block">
<span class="cmd-comment"># Status and reporting</span>
<span class="cmd-bin">python3</span> skills/guardian/scripts/admin.py <span class="cmd-arg">status</span>
<span class="cmd-bin">python3</span> skills/guardian/scripts/admin.py <span class="cmd-arg">report</span>
<span class="cmd-bin">python3</span> skills/guardian/scripts/admin.py <span class="cmd-arg">threats</span>

<span class="cmd-comment"># Temporary disable (testing / maintenance window)</span>
<span class="cmd-bin">python3</span> skills/guardian/scripts/admin.py <span class="cmd-arg">disable</span> --until 2h
<span class="cmd-bin">python3</span> skills/guardian/scripts/admin.py <span class="cmd-arg">enable</span>

<span class="cmd-comment"># Dismiss false positives</span>
<span class="cmd-bin">python3</span> skills/guardian/scripts/admin.py <span class="cmd-arg">dismiss</span> THREAT-ID

<span class="cmd-comment"># Update threat definitions from upstream</span>
<span class="cmd-bin">python3</span> skills/guardian/scripts/admin.py <span class="cmd-arg">update-defs</span>

<span class="cmd-comment"># Re-run onboarding (refresh GUARDIAN.md + notification)</span>
<span class="cmd-bin">python3</span> skills/guardian/scripts/onboard.py <span class="cmd-arg">--refresh</span>
      </div>
    </div>
  </div>

</div>

<footer>
  <span>ğŸ›¡ï¸ Guardian v<span id="footer-version">1.0.0</span> Â· <span id="footer-ts">â€”</span></span>
  <span class="footer-links">
    <a href="https://clawhub.ai/skills/guardian" target="_blank">ClawHub</a>
    <a href="../README.md" target="_blank">README</a>
  </span>
</footer>

<script>
// â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DATA_URLS = [
  // Try relative paths (works when served alongside guardian-threats.json)
  './guardian-threats.json',
  '../dashboard/guardian-threats.json',
  '../../../dashboard/guardian-threats.json',
];
const CONFIG_URLS = [
  './guardian-config.json',
  '../dashboard/guardian-config.json',
  '../../../dashboard/guardian-config.json',
];
const ACTION_ENDPOINTS = [
  'http://localhost:8080',
  'http://127.0.0.1:8080'
];
const REFRESH_MS = 15000;

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtNum(n) {
  if (n === null || n === undefined) return 'â€”';
  return Number(n).toLocaleString();
}
function fmtPct(n) {
  if (n === null || n === undefined) return 'â€”';
  return Number(n).toFixed(1) + '%';
}
function fmtAgo(ts) {
  if (!ts) return 'never';
  const d = new Date(ts);
  const s = Math.floor((Date.now() - d) / 1000);
  if (s < 5) return 'just now';
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return d.toLocaleDateString();
}
function fmtTime(ts) {
  if (!ts) return 'â€”';
  const d = new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
function fmtDateTime(ts) {
  if (!ts) return 'â€”';
  const d = new Date(ts);
  const date = d.toLocaleDateString();
  const time = d.toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
  const ms = String(d.getMilliseconds()).padStart(3, '0');
  return `${date} ${time}.${ms}`;
}
function escapeHtml(str='') {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}
function sevClass(s) {
  return 'sev-' + (s||'low').toLowerCase();
}

async function tryFetch(urls) {
  for (const url of urls) {
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (r.ok) return r.json();
    } catch(e) {}
  }
  return null;
}

async function postAction(path, payload) {
  for (const base of ACTION_ENDPOINTS) {
    try {
      const res = await fetch(base + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) return res.json();
    } catch (e) {}
  }
  throw new Error('No Guardian action endpoint reachable');
}

async function dismissThreat(threatId, btn) {
  if (!threatId) return;
  if (!confirm('Dismiss this threat? This will hide it from the dashboard but keep it in history.')) {
    return;
  }
  if (btn) { btn.disabled = true; btn.textContent = 'Dismissing...'; }
  try {
    await postAction('/dismiss', { id: threatId });
    if (btn) {
      btn.textContent = 'âœ“ Dismissed';
      btn.style.opacity = '0.5';
    }
    setTimeout(refresh, 500);
  } catch (e) {
    alert('Dismiss failed: ' + e.message + '\nEnsure Guardian API server is running:\npython3 skills/guardian/scripts/serve.py');
    if (btn) { btn.disabled = false; btn.textContent = 'Dismiss'; }
  }
}

async function ignoreSignature(sigId, btn) {
  if (!sigId) return;
  if (!confirm(`Ignore signature "${sigId}" permanently?\n\nThis will:\nâ€¢ Add it to dismissed_signatures in config\nâ€¢ Dismiss all existing matches\nâ€¢ Prevent future detections`)) {
    return;
  }
  if (btn) { btn.disabled = true; btn.textContent = 'Ignoring...'; }
  try {
    const result = await postAction('/ignore', { sig_id: sigId });
    if (btn) {
      btn.textContent = `âœ“ Ignored (${result.dismissed || 0} dismissed)`;
      btn.style.opacity = '0.5';
    }
    setTimeout(refresh, 500);
  } catch (e) {
    alert('Ignore failed: ' + e.message + '\n\nEnsure Guardian API server is running:\npython3 skills/guardian/scripts/serve.py --port 8080');
    if (btn) { btn.disabled = false; btn.textContent = 'Ignore future'; }
  }
}

async function approveThreat(threatId, btn) {
  if (!threatId) return;
  if (!confirm('Approve this as safe?\n\nThis will:\nâ€¢ Extract a pattern from the threat text\nâ€¢ Add it to allowlist_patterns in config\nâ€¢ Dismiss this threat\nâ€¢ Future matches will be skipped')) {
    return;
  }
  if (btn) { btn.disabled = true; btn.textContent = 'Approving...'; }
  try {
    const result = await postAction('/approve', { id: threatId });
    if (btn) {
      const patternPreview = result.pattern.length > 30 ? result.pattern.substring(0, 30) + '...' : result.pattern;
      btn.textContent = `âœ“ Approved`;
      btn.style.opacity = '0.5';
      btn.title = `Pattern: ${result.pattern}`;
    }
    setTimeout(refresh, 500);
  } catch (e) {
    alert('Approve failed: ' + e.message + '\nEnsure Guardian API server is running:\npython3 skills/guardian/scripts/serve.py');
    if (btn) { btn.disabled = false; btn.textContent = 'Approve'; }
  }
}

async function blockSender(threatId, btn) {
  if (!threatId) return;
  if (!confirm('Block this sender?\n\nThis will:\nâ€¢ Add the source to the blocklist\nâ€¢ Prevent future messages from this source\nâ€¢ Dismiss this threat\n\nNote: This blocks the source channel/file, not individual users.')) {
    return;
  }
  if (btn) { btn.disabled = true; btn.textContent = 'Blocking...'; }
  try {
    const result = await postAction('/block-sender', { id: threatId });
    if (btn) {
      btn.textContent = `âœ“ Blocked`;
      btn.style.opacity = '0.5';
      btn.title = `Blocked: ${result.blocked}`;
    }
    setTimeout(refresh, 500);
  } catch (e) {
    alert('Block sender failed: ' + e.message + '\nEnsure Guardian API server is running:\npython3 skills/guardian/scripts/serve.py');
    if (btn) { btn.disabled = false; btn.textContent = 'Block sender'; }
  }
}

async function escalateThreat(threatId, btn) {
  if (!threatId) return;
  if (!confirm('Escalate this threat for review?\n\nThis will:\nâ€¢ Flag the threat for human review\nâ€¢ Add it to the review queue\nâ€¢ Keep it visible in the dashboard\n\nUse this for threats that need expert analysis.')) {
    return;
  }
  if (btn) { btn.disabled = true; btn.textContent = 'Escalating...'; }
  try {
    const result = await postAction('/escalate', { id: threatId });
    if (btn) {
      btn.textContent = `âœ“ Escalated`;
      btn.style.opacity = '0.5';
    }
    setTimeout(refresh, 500);
  } catch (e) {
    alert('Escalate failed: ' + e.message + '\nEnsure Guardian API server is running:\npython3 skills/guardian/scripts/serve.py');
    if (btn) { btn.disabled = false; btn.textContent = 'Escalate'; }
  }
}

async function reportFalsePositive(threatId, btn) {
  if (!threatId) return;
  const comment = prompt('Report as false positive?\n\nOptional: Add a comment to help improve detection:', '');
  if (comment === null) return; // User cancelled
  
  if (btn) { btn.disabled = true; btn.textContent = 'Reporting...'; }
  try {
    const result = await postAction('/report-false-positive', { 
      id: threatId,
      comment: comment || 'No comment provided',
      reported_by: 'dashboard-user'
    });
    if (btn) {
      btn.textContent = `âœ“ Reported`;
      btn.style.opacity = '0.5';
    }
    alert('Thank you for reporting! This feedback helps improve Guardian.');
    setTimeout(refresh, 500);
  } catch (e) {
    alert('Report failed: ' + e.message + '\nEnsure Guardian API server is running:\npython3 skills/guardian/scripts/serve.py');
    if (btn) { btn.disabled = false; btn.textContent = 'False positive'; }
  }
}

async function viewSimilarThreats(threatId, btn) {
  if (!threatId) return;
  if (btn) { btn.disabled = true; btn.textContent = 'Loading...'; }
  try {
    const response = await fetch(ACTION_ENDPOINTS[0] + `/similar?id=${threatId}`);
    if (!response.ok) throw new Error('Failed to fetch similar threats');
    const result = await response.json();
    
    if (result.threats && result.threats.length > 0) {
      const details = result.threats.map(t => 
        `â€¢ [${t.severity.toUpperCase()}] ${t.description || t.sig_id}\n  ${fmtDateTime(t.detected_at)} - ${t.channel || '?'}`
      ).join('\n\n');
      alert(`Found ${result.count} similar threat(s):\n\n${details}`);
    } else {
      alert('No similar threats found.');
    }
    
    if (btn) { btn.disabled = false; btn.textContent = 'View similar'; }
  } catch (e) {
    alert('Failed to load similar threats: ' + e.message + '\nEnsure Guardian API server is running:\npython3 skills/guardian/scripts/serve.py');
    if (btn) { btn.disabled = false; btn.textContent = 'View similar'; }
  }
}

// â”€â”€â”€ Render threats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderThreats(data) {
  const tbody = document.getElementById('threats-tbody');
  const ts = document.getElementById('threats-ts');
  if (!data) {
    tbody.innerHTML = '<tr><td class="empty-row" colspan="4">âš ï¸ Could not load guardian-threats.json â€” is the data collector running?</td></tr>';
    return;
  }

  ts.textContent = 'updated ' + fmtAgo(data.generated || data.lastScan);

  // Stats
  const stats = data.stats || {};
  const scanned = stats.total_scanned || data.scanned || 0;
  const allThreats = stats.total_threats || (data.threats && data.threats.length) || 0;
  const unhandledThreats = (data.threats || []).filter(t => !t.dismissed && !t.blocked).length;
  const cleanRate = scanned > 0 ? ((scanned - allThreats) / scanned * 100) : 100;

  document.getElementById('stat-scanned').textContent = fmtNum(scanned);
  document.getElementById('stat-scan-rate').textContent = 'all channels monitored';
  document.getElementById('stat-threats').textContent = fmtNum(unhandledThreats);
  document.getElementById('stat-threat-sub').textContent = unhandledThreats === 0 ? 'system clean âœ…' : 'requires review';
  document.getElementById('stat-clean').textContent = fmtPct(cleanRate);
  document.getElementById('stat-sigs').textContent = fmtNum(stats.definitions || data.sigCount || 'â€”');

  const lastScan = data.lastScan || data.generated;
  document.getElementById('stat-last').textContent = lastScan ? fmtAgo(lastScan) : 'â€”';
  document.getElementById('stat-last-sub').textContent = lastScan ? fmtTime(lastScan) : '';

  // Badge
  const mode = data.mode || 'active';
  const badge = document.getElementById('header-badge');
  if (mode === 'disabled') {
    badge.className = 'status-badge status-disabled'; badge.textContent = 'â—‹ DISABLED';
  } else if (mode === 'monitor') {
    badge.className = 'status-badge status-monitor'; badge.textContent = 'â—‘ MONITOR';
  } else {
    badge.className = 'status-badge status-active'; badge.textContent = 'â— ACTIVE';
  }

  // Alert bar (only show for threats that need human review)
  const alertBar = document.getElementById('alert-bar');
  const needsReview = (t) => !t.dismissed && !t.blocked;
  const critThreats = (data.threats || []).filter(t => t.severity === 'critical' && needsReview(t));
  const highThreats = (data.threats || []).filter(t => t.severity === 'high' && needsReview(t));
  if (critThreats.length > 0) {
    alertBar.style.display = 'flex';
    alertBar.className = 'alert-bar alert-critical';
    alertBar.innerHTML = `ğŸ”´ <strong>${critThreats.length} CRITICAL threat${critThreats.length>1?'s':''}</strong> needs review â€” not yet blocked`;
  } else if (highThreats.length > 0) {
    alertBar.style.display = 'flex';
    alertBar.className = 'alert-bar alert-high';
    alertBar.innerHTML = `ğŸŸ  <strong>${highThreats.length} high-severity threat${highThreats.length>1?'s':''}</strong> needs review`;
  } else if (scanned > 0) {
    alertBar.style.display = 'flex';
    alertBar.className = 'alert-bar alert-info';
    alertBar.innerHTML = `âœ… System clean Â· ${fmtNum(scanned)} messages scanned Â· ${fmtPct(cleanRate)} clean rate`;
  } else {
    alertBar.style.display = 'none';
  }

  // Threats table
  const active = (data.threats || []).filter(t => !t.dismissed).slice(0, 20);
  if (active.length === 0) {
    tbody.innerHTML = '<tr><td class="empty-row" colspan="5">âœ… No active threats</td></tr>';
  } else {
    tbody.innerHTML = active.map(t => {
      const ts = t.detected_at || t.timestamp || t.ts;
      
      // Format context with visual highlighting for matched line
      let contextHtml = '';
      if (t.context) {
        const lines = String(t.context).split('\n');
        const formatted = lines.map(line => {
          const isMatch = line.startsWith('â–¶ ');
          const cleanLine = line.replace(/^[â–¶Â·] /, '');
          return isMatch 
            ? `<span class="ctx-line ctx-match">â–¶ ${escapeHtml(cleanLine)}</span>`
            : `<span class="ctx-line">Â· ${escapeHtml(cleanLine)}</span>`;
        }).join('\n');
        contextHtml = `<div class="context-block">${formatted}</div>`;
      }
      
      const desc = t.description || t.sig_id || 'â€”';
      const evidence = t.evidence ? escapeHtml(t.evidence) : 'â€”';
      const sigLabel = t.sig_id ? `Sig: ${escapeHtml(t.sig_id)}` : '';
      const statusLabel = t.blocked ? '<span style="color:var(--green)">âœ… Blocked</span>' : '<span style="color:var(--orange)">âš ï¸ Needs Review</span>';
      return `
      <tr data-id="${t.id || ''}" data-sig="${t.sig_id || ''}" style="${t.blocked ? 'opacity:0.6' : ''}">
        <td><span class="sev-pill ${sevClass(t.severity)}">${(t.severity||'low').toUpperCase()}</span></td>
        <td><span class="channel-tag">${t.source || t.channel || '?'}</span></td>
        <td>
          <div class="threat-desc" title="${escapeHtml(desc)}">${escapeHtml(desc)}</div>
          <div class="threat-meta">${statusLabel} Â· ${sigLabel ? sigLabel + ' Â· ' : ''}Evidence: ${evidence}</div>
          ${contextHtml}
        </td>
        <td class="threat-ts">
          <div class="ts-main">${fmtDateTime(ts)}</div>
          <div class="ts-sub">${fmtAgo(ts)}</div>
        </td>
        <td>
          <div class="actions">
            <button class="btn btn-success" data-action="approve" data-id="${t.id || ''}" title="Mark as safe and add to allowlist">âœ“ Approve</button>
            <button class="btn btn-ghost" data-action="dismiss" data-id="${t.id || ''}" title="Hide this threat">Dismiss</button>
            <button class="btn btn-outline" data-action="view-similar" data-id="${t.id || ''}" title="Show similar threats">View similar</button>
            <button class="btn btn-danger" data-action="block-sender" data-id="${t.id || ''}" title="Block this source">ğŸš« Block sender</button>
            <button class="btn btn-warning" data-action="escalate" data-id="${t.id || ''}" title="Flag for human review">âš  Escalate</button>
            <button class="btn btn-outline" data-action="report-fp" data-id="${t.id || ''}" title="Report as incorrect detection">False positive</button>
            <button class="btn btn-outline" data-action="ignore" data-sig="${t.sig_id || ''}" title="Ignore this signature permanently">Ignore signature</button>
          </div>
        </td>
      </tr>`;
    }).join('');

    tbody.querySelectorAll('[data-action="dismiss"]').forEach(btn => {
      btn.addEventListener('click', () => dismissThreat(btn.dataset.id, btn));
    });
    tbody.querySelectorAll('[data-action="ignore"]').forEach(btn => {
      btn.addEventListener('click', () => ignoreSignature(btn.dataset.sig, btn));
    });
    tbody.querySelectorAll('[data-action="approve"]').forEach(btn => {
      btn.addEventListener('click', () => approveThreat(btn.dataset.id, btn));
    });
    tbody.querySelectorAll('[data-action="block-sender"]').forEach(btn => {
      btn.addEventListener('click', () => blockSender(btn.dataset.id, btn));
    });
    tbody.querySelectorAll('[data-action="escalate"]').forEach(btn => {
      btn.addEventListener('click', () => escalateThreat(btn.dataset.id, btn));
    });
    tbody.querySelectorAll('[data-action="report-fp"]').forEach(btn => {
      btn.addEventListener('click', () => reportFalsePositive(btn.dataset.id, btn));
    });
    tbody.querySelectorAll('[data-action="view-similar"]').forEach(btn => {
      btn.addEventListener('click', () => viewSimilarThreats(btn.dataset.id, btn));
    });
  }

  // Channel breakdown
  const chanPanel = document.getElementById('channels-panel');
  const channels = data.channels || stats.by_channel || {};
  const chanEntries = Object.entries(channels).sort((a,b) => b[1]-a[1]);
  const maxChan = chanEntries.length > 0 ? chanEntries[0][1] : 1;
  if (chanEntries.length === 0) {
    chanPanel.innerHTML = '<div style="color:var(--muted);font-size:13px">No channel data yet</div>';
  } else {
    chanPanel.innerHTML = chanEntries.map(([ch, cnt]) => `
      <div class="channel-row">
        <span class="channel-name">${ch}</span>
        <div class="channel-bar-wrap"><div class="channel-bar" style="width:${Math.max(4, cnt/maxChan*100)}%"></div></div>
        <span class="channel-count">${cnt}</span>
      </div>
    `).join('');
  }
}

// â”€â”€â”€ Render config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderConfig(data) {
  const list = document.getElementById('config-list');
  if (!data) {
    list.innerHTML = '<li><span class="config-key">guardian-config.json not found</span></li>';
    return;
  }

  const cfg = data.config || data;
  const items = [
    ['Enabled', cfg.enabled !== false, cfg.enabled !== false ? 'on' : 'off'],
    ['Admin Override', cfg.admin_override, cfg.admin_override ? 'warn' : 'on'],
    ['Threshold', (cfg.severity_threshold||'medium').toUpperCase(), ''],
    ['Scan Interval', (cfg.scan_interval_minutes||2) + ' min', ''],
    ['Alert on Critical', cfg.alerts?.notify_on_critical !== false, cfg.alerts?.notify_on_critical !== false ? 'on' : 'off'],
    ['Daily Digest', cfg.alerts?.daily_digest !== false, cfg.alerts?.daily_digest !== false ? 'on' : 'off'],
    ['Monitor All', cfg.channels?.monitor_all !== false, cfg.channels?.monitor_all !== false ? 'on' : 'warn'],
  ];

  list.innerHTML = items.map(([k, v, cls]) => {
    const display = typeof v === 'boolean' ? (v ? 'ON' : 'OFF') : v;
    return `<li>
      <span class="config-key">${k}</span>
      <span class="config-val ${cls}">${display}</span>
    </li>`;
  }).join('');

  // Version in footer
  if (data.version) document.getElementById('footer-version').textContent = data.version;
}

// â”€â”€â”€ Refresh loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refresh() {
  document.getElementById('footer-ts').textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
  const [threats, config] = await Promise.all([
    tryFetch(DATA_URLS),
    tryFetch(CONFIG_URLS),
  ]);
  renderThreats(threats);
  renderConfig(config);
}

refresh();
setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
