#!/bin/bash
#
# Handler for custom webhooks
# Auto-generated by register.sh
#

set -euo pipefail

PAYLOAD="$1"
SOURCE="$2"
EVENT_TYPE="${3:-unknown}"

ALERT_CHANNEL="${WEBHOOK_ALERT_CHANNEL:-telegram}"
VAULT_SECTION="webhooks/custom"

# Helper functions
send_alert() {
    local title="$1"
    local body="$2"
    echo "ALERT: $title - $body"
    if command -v message &> /dev/null; then
        message send "$ALERT_CHANNEL" "$title" <<< "$body" 2>/dev/null || true
    fi
}

write_to_vault() {
    local path="$1"
    local content="$2"
    local tags="$3"
    if command -v vault &> /dev/null; then
        vault write "$path" --data "$content" --tags "$tags" 2>/dev/null || true
    fi
}

TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# TODO: Add your parsing logic here
# Example: Extract fields from payload
# FIELD=$(echo "$PAYLOAD" | jq -r '.field // "unknown"')

# Log to vault
VAULT_CONTENT=$(jq -n \
    --arg ts "$TIMESTAMP" \
    --arg source "$SOURCE" \
    --arg event "$EVENT_TYPE" \
    --arg payload "$PAYLOAD" \
    '{
        timestamp: $ts,
        source: $source,
        event_type: $event,
        payload: $payload
    }')

write_to_vault "${VAULT_SECTION}/${SOURCE}/${TIMESTAMP}" "$VAULT_CONTENT" "custom,webhook"

# TODO: Add event-specific handling
# case "$EVENT_TYPE" in
#     event.name)
#         # Handle specific event
#         send_alert "Event occurred" "Details here"
#         ;;
# esac

echo "Processed custom webhook: $EVENT_TYPE from $SOURCE"
exit 0
