{% extends "base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - Aè‚¡é‡åŒ–ç›‘æ§{% endblock %}

{% block extra_css %}
<style>
    :root {
        --color-red: #f5222d;
        --color-green: #52c41a;
        --color-blue: #1890ff;
        --color-orange: #fa8c16;
        --bg-light: #fafafa;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    body {
        background-color: var(--bg-light);
    }
    
    /* é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ */
    .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .stat-card.red::before { background: var(--color-red); }
    .stat-card.green::before { background: var(--color-green); }
    .stat-card.blue::before { background: var(--color-blue); }
    .stat-card.orange::before { background: var(--color-orange); }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
    }
    
    .stat-icon {
        font-size: 36px;
        margin-bottom: 12px;
        opacity: 0.9;
    }
    
    .stat-label {
        font-size: 14px;
        color: #8c8c8c;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #262626;
        line-height: 1;
        margin-bottom: 8px;
    }
    
    .stat-change {
        font-size: 13px;
        font-weight: 500;
    }
    
    .stat-change.up {
        color: var(--color-red);
    }
    
    .stat-change.down {
        color: var(--color-green);
    }
    
    /* ä¸»è¦åŒºåŸŸ */
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }
    
    @media (max-width: 992px) {
        .main-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .panel {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: var(--shadow-sm);
    }
    
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .panel-title {
        font-size: 18px;
        font-weight: 600;
        color: #262626;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .panel-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: 1px solid #d9d9d9;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .btn-icon:hover {
        border-color: var(--color-blue);
        color: var(--color-blue);
        transform: scale(1.1);
    }
    
    /* è‚¡ç¥¨ç½‘æ ¼ */
    .stocks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
    }
    
    .stock-mini-card {
        background: #fafafa;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .stock-mini-card:hover {
        background: white;
        border-color: var(--color-blue);
        box-shadow: var(--shadow-sm);
        transform: translateY(-2px);
    }
    
    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }
    
    .stock-name {
        font-size: 16px;
        font-weight: 600;
        color: #262626;
        margin-bottom: 2px;
    }
    
    .stock-code {
        font-size: 12px;
        color: #8c8c8c;
        font-family: 'Monaco', monospace;
    }
    
    .stock-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #52c41a;
    }
    
    .stock-status.warning { background: #faad14; }
    .stock-status.danger { background: #f5222d; }
    
    .stock-price-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
    }
    
    .stock-price {
        font-size: 24px;
        font-weight: 700;
        color: #262626;
    }
    
    .stock-change {
        font-size: 14px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 4px;
    }
    
    .stock-change.positive {
        color: var(--color-red);
        background: #fff1f0;
    }
    
    .stock-change.negative {
        color: var(--color-green);
        background: #f6ffed;
    }
    
    .stock-indicators {
        display: flex;
        gap: 12px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f0f0f0;
    }
    
    .indicator {
        flex: 1;
        text-align: center;
    }
    
    .indicator-label {
        font-size: 11px;
        color: #8c8c8c;
        margin-bottom: 2px;
    }
    
    .indicator-value {
        font-size: 13px;
        font-weight: 600;
        color: #262626;
    }
    
    /* æ’è¡Œæ¦œ */
    .rank-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .rank-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #fafafa;
        transition: all 0.2s;
    }
    
    .rank-item:hover {
        background: #f0f0f0;
    }
    
    .rank-number {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #d9d9d9;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin-right: 12px;
    }
    
    .rank-number.top1 { background: linear-gradient(135deg, #fadb14 0%, #d4b106 100%); }
    .rank-number.top2 { background: linear-gradient(135deg, #bfbfbf 0%, #8c8c8c 100%); }
    .rank-number.top3 { background: linear-gradient(135deg, #d4380d 0%, #a8071a 100%); }
    
    .rank-info {
        flex: 1;
    }
    
    .rank-name {
        font-size: 14px;
        font-weight: 500;
        color: #262626;
    }
    
    .rank-code {
        font-size: 12px;
        color: #8c8c8c;
        font-family: 'Monaco', monospace;
    }
    
    .rank-value {
        font-size: 16px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 6px;
    }
    
    .rank-value.gainer {
        color: var(--color-red);
        background: #fff1f0;
    }
    
    .rank-value.loser {
        color: var(--color-green);
        background: #f6ffed;
    }
    
    /* å¸‚åœºæƒ…ç»ª */
    .sentiment-meter {
        margin: 24px 0;
    }
    
    .sentiment-bar {
        height: 40px;
        border-radius: 20px;
        background: linear-gradient(90deg, #52c41a 0%, #faad14 50%, #f5222d 100%);
        position: relative;
        margin-bottom: 12px;
    }
    
    .sentiment-indicator {
        position: absolute;
        top: -8px;
        width: 4px;
        height: 56px;
        background: #262626;
        border-radius: 2px;
        transition: left 0.5s;
    }
    
    .sentiment-labels {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: #8c8c8c;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-container {
        text-align: center;
        padding: 60px 20px;
    }
    
    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #f0f0f0;
        border-top-color: var(--color-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }
    
    .empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
    
    .empty-text {
        font-size: 14px;
        color: #8c8c8c;
    }
    
    /* å¸‚åœºçƒ­åº¦ */
    .heat-meter {
        padding: 20px;
    }
    
    .heat-display {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .heat-value {
        font-size: 56px;
        font-weight: 700;
        line-height: 1;
        background: linear-gradient(135deg, #52c41a 0%, #faad14 50%, #f5222d 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .heat-level {
        font-size: 18px;
        font-weight: 600;
        color: #262626;
        margin-top: 8px;
    }
    
    .heat-bar {
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 8px;
    }
    
    .heat-fill {
        height: 100%;
        background: linear-gradient(90deg, #52c41a 0%, #faad14 50%, #f5222d 100%);
        transition: width 0.5s ease;
    }
    
    .heat-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #8c8c8c;
    }
    
    .heat-stats {
        padding-top: 16px;
        border-top: 1px solid #f0f0f0;
    }
    
    .stat-mini-value {
        font-size: 18px;
        font-weight: 600;
        color: #262626;
    }
    
    .stat-mini-label {
        font-size: 12px;
        color: #8c8c8c;
        margin-top: 4px;
    }
    
    .heat-description {
        text-align: center;
        padding: 12px;
        background: #fafafa;
        border-radius: 6px;
    }
    
    /* æ¿å—åˆ—è¡¨ */
    .sector-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .sector-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        margin-bottom: 8px;
        background: #fafafa;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .sector-item:hover {
        background: #f0f0f0;
    }
    
    .sector-info {
        flex: 1;
    }
    
    .sector-name {
        font-size: 14px;
        font-weight: 600;
        color: #262626;
        margin-bottom: 2px;
    }
    
    .sector-meta {
        font-size: 12px;
        color: #8c8c8c;
    }
    
    .sector-value {
        font-size: 16px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 4px;
        white-space: nowrap;
    }
    
    .sector-value.positive {
        color: var(--color-red);
        background: #fff1f0;
    }
    
    .sector-value.negative {
        color: var(--color-green);
        background: #f6ffed;
    }
    
    .sector-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
        margin-left: 6px;
    }
    
    .sector-badge.hot {
        background: #fff1f0;
        color: #cf1322;
    }
    
    .sector-badge.cold {
        background: #f6ffed;
        color: #389e0d;
    }

    /* æ—¶é—´æ ‡ç­¾ */
    .time-badge {
        font-size: 12px;
        color: #8c8c8c;
        padding: 4px 8px;
        background: #f5f5f5;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 1. å¸‚åœºæƒ…ç»ª (ç½®é¡¶) -->
    <div class="panel mb-4">
        <div class="panel-header">
            <div class="panel-title">
                <span>ğŸ­</span>
                <span>å¸‚åœºæƒ…ç»ª</span>
                <span style="font-size: 14px; font-weight: 500; color: #8c8c8c; margin-left: 8px;" id="sentimentScoreDisplay">--</span>
            </div>
            <div class="time-badge" id="sentimentUpdate">--</div>
        </div>
        
        <div class="sentiment-meter">
            <div class="sentiment-bar">
                <div class="sentiment-indicator" id="sentimentIndicator" style="left: 50%;"></div>
            </div>
            <div class="sentiment-labels">
                <span>ğŸŸ¢ æåº¦æ‚²è§‚</span>
                <span>ğŸ˜ ä¸­æ€§</span>
                <span>ğŸ”´ æåº¦ä¹è§‚</span>
            </div>
        </div>
        
        <div class="row text-center mt-3 mb-3">
            <div class="col-2">
                <div style="font-size: 24px; font-weight: 600; color: var(--color-red);" id="sentiment-limit-up">--</div>
                <div style="font-size: 13px; color: #8c8c8c;">æ¶¨åœ</div>
            </div>
            <div class="col-2">
                <div style="font-size: 24px; font-weight: 600; color: var(--color-red);" id="sentiment-bullish">--</div>
                <div style="font-size: 13px; color: #8c8c8c;">ä¸Šæ¶¨</div>
            </div>
            <div class="col-2">
                <div style="font-size: 24px; font-weight: 600; color: #8c8c8c;" id="sentiment-neutral">--</div>
                <div style="font-size: 13px; color: #8c8c8c;">å¹³ç›˜</div>
            </div>
            <div class="col-2">
                <div style="font-size: 24px; font-weight: 600; color: var(--color-green);" id="sentiment-bearish">--</div>
                <div style="font-size: 13px; color: #8c8c8c;">ä¸‹è·Œ</div>
            </div>
            <div class="col-2">
                <div style="font-size: 24px; font-weight: 600; color: var(--color-green);" id="sentiment-limit-down">--</div>
                <div style="font-size: 13px; color: #8c8c8c;">è·Œåœ</div>
            </div>
            <div class="col-2">
                <div style="font-size: 24px; font-weight: 600; color: var(--color-orange);" id="sentiment-avg-change">--</div>
                <div style="font-size: 13px; color: #8c8c8c;">å¹³å‡æ¶¨å¹…</div>
            </div>
        </div>
        
        <div class="heat-description" id="sentimentDescription">
            <small class="text-muted">æ­£åœ¨åŠ è½½å…¨å¸‚åœºæ•°æ®...</small>
        </div>
    </div>
    
    <!-- 2. ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stat-cards">
        <div class="stat-card red">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-label">ç›‘æ§è‚¡ç¥¨</div>
            <div class="stat-value" id="totalStocks">--</div>
            <div class="stat-change">å®æ—¶è·Ÿè¸ª</div>
        </div>
        
        <div class="stat-card green">
            <div class="stat-icon">ğŸ”º</div>
            <div class="stat-label">ä¸Šæ¶¨æ•°é‡</div>
            <div class="stat-value up" id="gainersCount">--</div>
            <div class="stat-change up" id="gainersPercent">--</div>
        </div>
        
        <div class="stat-card blue">
            <div class="stat-icon">ğŸ”»</div>
            <div class="stat-label">ä¸‹è·Œæ•°é‡</div>
            <div class="stat-value down" id="losersCount">--</div>
            <div class="stat-change down" id="losersPercent">--</div>
        </div>
        
        <div class="stat-card orange">
            <div class="stat-icon">ğŸ’¹</div>
            <div class="stat-label">å¹³å‡æ¶¨å¹…</div>
            <div class="stat-value" id="avgChange">--</div>
            <div class="stat-change" id="avgChangeText">--</div>
        </div>
    </div>
    
    <!-- 3. ä¸»è¦å†…å®¹åŒº -->
    <div class="main-grid">
        <!-- å·¦ä¾§ï¼šè‚¡ç¥¨åˆ—è¡¨ -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <span>ğŸ“Š</span>
                    <span>ç›‘æ§è‚¡ç¥¨</span>
                </div>
                <div class="panel-actions">
                    <div class="time-badge" id="lastUpdate">--</div>
                    <button class="btn-icon" onclick="loadStocks()" title="åˆ·æ–°">
                        ğŸ”„
                    </button>
                </div>
            </div>
            
            <div id="stocksContainer">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div>æ­£åœ¨åŠ è½½è‚¡ç¥¨æ•°æ®...</div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šæ’è¡Œæ¦œå’Œå¸‚åœºæƒ…ç»ª -->
        <div>
            <!-- æ¶¨å¹…æ¦œ -->
            <div class="panel mb-3">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ”¥</span>
                        <span>æ¶¨å¹…æ¦œ</span>
                    </div>
                </div>
                <ul class="rank-list" id="topGainers">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                    </div>
                </ul>
            </div>
            
            <!-- è·Œå¹…æ¦œ -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>â„ï¸</span>
                        <span>è·Œå¹…æ¦œ</span>
                    </div>
                </div>
                <ul class="rank-list" id="topLosers">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                    </div>
                </ul>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
let refreshInterval = null;
let realtimeInterval = null;
let isTradingTime = false;


// å¸‚åœºçƒ­åº¦ã€çƒ­é—¨æ¿å—ã€ä¸»åŠ›èµ„é‡‘æ¨¡å—å·²ç§»é™¤


// åŠ è½½è‚¡ç¥¨æ•°æ®
function loadStocks() {
    $.ajax({
        url: '/api/stocks',
        method: 'GET',
        success: function(response) {
            if (response.status === 'success') {
                displayStocks(response.data);
                updateStats(response.data);
                updateRankings(response.data);
                // updateSentiment å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨ loadMarketSentiment() åŠ è½½å…¨å¸‚åœºæƒ…ç»ª
                $('#lastUpdate').text(new Date().toLocaleTimeString());
            }
        },
        error: function() {
            $('#stocksContainer').html(`
                <div class="empty-state">
                    <div class="empty-icon">ğŸ˜•</div>
                    <div class="empty-text">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>
                </div>
            `);
        }
    });
}

// æ˜¾ç¤ºè‚¡ç¥¨å¡ç‰‡
function displayStocks(stocks) {
    if (!stocks || stocks.length === 0) {
        $('#stocksContainer').html(`
            <div class="empty-state">
                <div class="empty-icon">ğŸ“­</div>
                <div class="empty-text">æš‚æ— ç›‘æ§è‚¡ç¥¨</div>
            </div>
        `);
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è‚¡ç¥¨æ•°æ®éƒ½æ— æ•ˆ
    const validStocks = stocks.filter(s => s.price !== null && s.price !== undefined);
    if (validStocks.length === 0) {
        $('#stocksContainer').html(`
            <div class="empty-state">
                <div class="empty-icon">â°</div>
                <div class="empty-text">éäº¤æ˜“æ—¶é—´ï¼Œæš‚æ— å®æ—¶æ•°æ®</div>
                <div style="font-size: 13px; color: #8c8c8c; margin-top: 8px;">
                    äº¤æ˜“æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:30-15:00
                </div>
            </div>
        `);
        return;
    }
    
    let html = '<div class="stocks-grid">';
    
    stocks.forEach(function(stock) {
        // å¤„ç†nullå€¼
        const price = stock.price || 0;
        const changePct = stock.change_pct || 0;
        const amount = stock.amount || 0;
        const turnover = stock.turnover || 0;
        
        const changeClass = changePct >= 0 ? 'positive' : 'negative';
        const changeSign = changePct >= 0 ? '+' : '';
        
        // çŠ¶æ€åˆ¤æ–­
        let statusClass = '';
        const rsi = stock.tech_indicators?.rsi || 50;
        if (rsi < 30) statusClass = 'danger';
        else if (rsi > 70) statusClass = 'warning';
        
        html += `
        <div class="stock-mini-card" data-code="${stock.code}" onclick="location.href='/stock/${stock.code}'">
            <div class="stock-header">
                <div>
                    <div class="stock-name">${stock.name}</div>
                    <div class="stock-code">${stock.code}</div>
                </div>
                <div class="stock-status ${statusClass}"></div>
            </div>
            
            <div class="stock-price-row">
                <div class="stock-price">Â¥${price.toFixed(2)}</div>
                <div class="stock-change ${changeClass}">
                    ${changeSign}${changePct.toFixed(2)}%
                </div>
            </div>
            
            <div class="stock-indicators">
                <div class="indicator">
                    <div class="indicator-label">æˆäº¤é¢</div>
                    <div class="indicator-value">${formatAmount(amount)}</div>
                </div>
                <div class="indicator">
                    <div class="indicator-label">æ¢æ‰‹ç‡</div>
                    <div class="indicator-value">${turnover.toFixed(2)}%</div>
                </div>
            </div>
        </div>
        `;
    });
    
    html += '</div>';
    $('#stocksContainer').html(html);
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®
function updateStats(stocks) {
    const total = stocks.length;
    
    // è¿‡æ»¤æœ‰æ•ˆæ•°æ®
    const validStocks = stocks.filter(s => s.change_pct !== null && s.change_pct !== undefined);
    
    if (validStocks.length === 0) {
        // æ— æœ‰æ•ˆæ•°æ®æ—¶æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        $('#totalStocks').text(total);
        $('#gainersCount').text('--');
        $('#losersCount').text('--');
        $('#gainersPercent').text('ç­‰å¾…æ•°æ®');
        $('#losersPercent').text('ç­‰å¾…æ•°æ®');
        $('#avgChange').text('--');
        $('#avgChangeText').text('éäº¤æ˜“æ—¶é—´');
        return;
    }
    
    const gainers = validStocks.filter(s => s.change_pct > 0).length;
    const losers = validStocks.filter(s => s.change_pct < 0).length;
    const avgChange = validStocks.reduce((sum, s) => sum + (s.change_pct || 0), 0) / validStocks.length;
    
    $('#totalStocks').text(total);
    $('#gainersCount').text(gainers);
    $('#losersCount').text(losers);
    $('#gainersPercent').text(`${(gainers/validStocks.length*100).toFixed(0)}% ä¸Šæ¶¨`);
    $('#losersPercent').text(`${(losers/validStocks.length*100).toFixed(0)}% ä¸‹è·Œ`);
    $('#avgChange').text((avgChange >= 0 ? '+' : '') + avgChange.toFixed(2) + '%');
    $('#avgChangeText').text(avgChange >= 0 ? 'å¸‚åœºåå¼º' : 'å¸‚åœºåå¼±');
}

// æ›´æ–°æ’è¡Œæ¦œ
function updateRankings(stocks) {
    // è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®
    const validStocks = stocks.filter(s => s.change_pct !== null && s.change_pct !== undefined);
    
    if (validStocks.length === 0) {
        // æ— æœ‰æ•ˆæ•°æ®æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
        const emptyHtml = `
            <div class="empty-state">
                <div class="empty-icon" style="font-size: 32px; margin-bottom: 8px;">â°</div>
                <div class="empty-text">éäº¤æ˜“æ—¶é—´</div>
                <div style="font-size: 12px; color: #8c8c8c; margin-top: 4px;">
                    ç­‰å¾…æ•°æ®æ›´æ–°
                </div>
            </div>
        `;
        $('#topGainers').html(emptyHtml);
        $('#topLosers').html(emptyHtml);
        return;
    }
    
    // æ¶¨å¹…æ¦œ
    const gainers = validStocks.slice().sort((a, b) => (b.change_pct || 0) - (a.change_pct || 0)).slice(0, 5);
    let gainersHtml = '';
    gainers.forEach((stock, index) => {
        const rankClass = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : '';
        const changePct = stock.change_pct || 0;
        gainersHtml += `
        <li class="rank-item" onclick="location.href='/stock/${stock.code}'">
            <div class="rank-number ${rankClass}">${index + 1}</div>
            <div class="rank-info">
                <div class="rank-name">${stock.name}</div>
                <div class="rank-code">${stock.code}</div>
            </div>
            <div class="rank-value gainer">${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%</div>
        </li>
        `;
    });
    $('#topGainers').html(gainersHtml || '<div class="empty-state"><div class="empty-text">æš‚æ— æ•°æ®</div></div>');
    
    // è·Œå¹…æ¦œ
    const losers = validStocks.slice().sort((a, b) => (a.change_pct || 0) - (b.change_pct || 0)).slice(0, 5);
    let losersHtml = '';
    losers.forEach((stock, index) => {
        const rankClass = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : '';
        const changePct = stock.change_pct || 0;
        losersHtml += `
        <li class="rank-item" onclick="location.href='/stock/${stock.code}'">
            <div class="rank-number ${rankClass}">${index + 1}</div>
            <div class="rank-info">
                <div class="rank-name">${stock.name}</div>
                <div class="rank-code">${stock.code}</div>
            </div>
            <div class="rank-value loser">${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%</div>
        </li>
        `;
    });
    $('#topLosers').html(losersHtml || '<div class="empty-state"><div class="empty-text">æš‚æ— æ•°æ®</div></div>');
}

// æ³¨æ„ï¼šå¸‚åœºæƒ…ç»ªç°åœ¨åŸºäºå…¨å¸‚åœºAè‚¡æ•°æ®ï¼Œç”± loadMarketSentiment() å‡½æ•°åŠ è½½

// æ ¼å¼åŒ–é‡‘é¢
function formatAmount(amount) {
    if (amount >= 100000000) {
        return (amount / 100000000).toFixed(2) + 'äº¿';
    } else if (amount >= 10000) {
        return (amount / 10000).toFixed(2) + 'ä¸‡';
    }
    return amount.toFixed(0);
}

// åŠ è½½å…¨å¸‚åœºæƒ…ç»ª
function loadMarketSentiment() {
    $.ajax({
        url: '/api/market/sentiment',
        method: 'GET',
        success: function(response) {
            if (response.status === 'success') {
                updateMarketSentiment(response.data);
            }
        },
        error: function() {
            console.error('åŠ è½½å¸‚åœºæƒ…ç»ªå¤±è´¥');
        }
    });
}

// æ›´æ–°å…¨å¸‚åœºæƒ…ç»ªæ˜¾ç¤º
function updateMarketSentiment(data) {
    const score = data.score;
    const stats = data.stats;
    const isDemoMode = data.demo_mode || false;
    const isHistorical = data.is_historical || false;
    
    // æ›´æ–°æƒ…ç»ªæ¡ä½ç½®
    $('#sentimentIndicator').css('left', score + '%');
    
    // æ›´æ–°æ ‡é¢˜æ˜¾ç¤º
    let displayText = `${data.emoji} ${data.level} (${score.toFixed(0)}åˆ†)`;
    if (isDemoMode) {
        displayText += ' [æ¼”ç¤º]';
    } else if (isHistorical) {
        displayText += ' [å†å²]';
    }
    $('#sentimentScoreDisplay').text(displayText);
    
    // æ›´æ–°ç»Ÿè®¡æ•°å­—
    $('#sentiment-limit-up').text(stats.limit_up);
    $('#sentiment-bullish').text(stats.gainers);
    $('#sentiment-neutral').text(stats.neutral);
    $('#sentiment-bearish').text(stats.losers);
    $('#sentiment-limit-down').text(stats.limit_down);
    $('#sentiment-avg-change').text((stats.avg_change >= 0 ? '+' : '') + stats.avg_change.toFixed(2) + '%');
    
    // æ›´æ–°æè¿°
    let descriptionText = `
        <strong>${data.description}</strong> Â· 
        æ¶¨åœ${stats.limit_up}åª è·Œåœ${stats.limit_down}åª Â· 
        å¼ºåŠ¿è‚¡${stats.strong_stocks}åª å¼±åŠ¿è‚¡${stats.weak_stocks}åª Â· 
        å¹³å‡æ¢æ‰‹${stats.avg_turnover.toFixed(2)}% æ³¢åŠ¨ç‡${stats.avg_volatility.toFixed(2)}%
    `;
    if (isDemoMode) {
        descriptionText += ' Â· <span style="color: #fa8c16;">âš ï¸ æ¼”ç¤ºæ•°æ®ï¼ˆéäº¤æ˜“æ—¶é—´ï¼‰</span>';
    } else if (isHistorical && data.data_time) {
        descriptionText += ` Â· <span style="color: #1890ff;">ğŸ“… æ•°æ®æ—¶é—´: ${data.data_time}</span>`;
    }
    $('#sentimentDescription').html(`<small class="text-muted">${descriptionText}</small>`);
    
    // æ›´æ–°æ—¶é—´
    $('#sentimentUpdate').text(data.update_time);
    
    console.log('å¸‚åœºæƒ…ç»ª:', data);
}

// åˆ¤æ–­æ˜¯å¦æ˜¯äº¤æ˜“æ—¶é—´ï¼ˆå‰ç«¯ç®€å•åˆ¤æ–­ï¼‰
function checkTradingTime() {
    const now = new Date();
    const day = now.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
    const hour = now.getHours();
    const minute = now.getMinutes();
    const time = hour * 60 + minute;
    
    // å‘¨æœ«
    if (day === 0 || day === 6) {
        return false;
    }
    
    // äº¤æ˜“æ—¶é—´: 9:15-11:30, 13:00-15:00
    const morningStart = 9 * 60 + 15;   // 9:15
    const morningEnd = 11 * 60 + 30;     // 11:30
    const afternoonStart = 13 * 60;      // 13:00
    const afternoonEnd = 15 * 60;        // 15:00
    
    return (time >= morningStart && time <= morningEnd) || 
           (time >= afternoonStart && time <= afternoonEnd);
}

// å®æ—¶æ›´æ–°ä»·æ ¼ï¼ˆè½»é‡çº§ï¼Œä»…æ›´æ–°ä»·æ ¼å’Œæ¶¨è·Œï¼‰
function updateRealtimePrices() {
    $.ajax({
        url: '/api/stocks/realtime',
        method: 'GET',
        success: function(response) {
            if (response.status === 'success' && response.data) {
                response.data.forEach(function(stock) {
                    // æ›´æ–°ä»·æ ¼
                    $(`.stock-mini-card[data-code="${stock.code}"] .stock-price`).text('Â¥' + (stock.price || 0).toFixed(2));
                    
                    // æ›´æ–°æ¶¨è·Œå¹…
                    const changePct = stock.change_pct || 0;
                    const changeClass = changePct >= 0 ? 'positive' : 'negative';
                    const changeSign = changePct >= 0 ? '+' : '';
                    $(`.stock-mini-card[data-code="${stock.code}"] .stock-change`)
                        .attr('class', 'stock-change ' + changeClass)
                        .text(changeSign + changePct.toFixed(2) + '%');
                });
                
                $('#lastUpdate').text(new Date().toLocaleTimeString());
            }
        },
        error: function() {
            console.error('å®æ—¶ä»·æ ¼æ›´æ–°å¤±è´¥');
        }
    });
}

// å¯åŠ¨/åœæ­¢å®æ—¶æ›´æ–°
function startRealtimeUpdate() {
    if (realtimeInterval) {
        clearInterval(realtimeInterval);
    }
    
    isTradingTime = checkTradingTime();
    
    if (isTradingTime) {
        console.log('âœ… äº¤æ˜“æ—¶é—´ï¼Œå¯åŠ¨å®æ—¶æ›´æ–°ï¼ˆæ¯5ç§’ï¼‰');
        // äº¤æ˜“æ—¶é—´ï¼šæ¯5ç§’æ›´æ–°ä¸€æ¬¡ä»·æ ¼
        realtimeInterval = setInterval(updateRealtimePrices, 5000);
    } else {
        console.log('â¸ï¸ éäº¤æ˜“æ—¶é—´ï¼Œåœæ­¢å®æ—¶æ›´æ–°');
        // éäº¤æ˜“æ—¶é—´ï¼šåœæ­¢å®æ—¶æ›´æ–°
        realtimeInterval = null;
    }
}

// é¡µé¢åŠ è½½
$(document).ready(function() {
    // åˆå§‹åŠ è½½
    loadStocks();
    loadMarketSentiment();
    
    // æ£€æŸ¥äº¤æ˜“æ—¶é—´å¹¶å¯åŠ¨å®æ—¶æ›´æ–°
    startRealtimeUpdate();
    
    // æ¯30ç§’åˆ·æ–°å®Œæ•´æ•°æ®ï¼ˆåŒ…æ‹¬æŠ€æœ¯æŒ‡æ ‡ã€èµ„é‡‘æµç­‰ï¼‰
    refreshInterval = setInterval(function() {
        loadStocks();
        loadMarketSentiment();
        
        // é‡æ–°æ£€æŸ¥äº¤æ˜“æ—¶é—´ï¼ˆé˜²æ­¢è·¨æ—¶æ®µï¼‰
        startRealtimeUpdate();
    }, 30000);
});

// é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
$(window).on('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
